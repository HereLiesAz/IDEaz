name: Auto Release (Consolidated)

on:
  workflow_run:
    workflows: ["Android CI with Jules AI Debugging"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Verify other workflows
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = "${{ github.event.workflow_run.head_sha }}";

            console.log(`Checking status for commit ${ref}`);

            const { data: checks } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref,
              per_page: 100
            });

            const failures = checks.check_runs.filter(c => c.conclusion === 'failure' || c.conclusion === 'timed_out');
            if (failures.length > 0) {
              const names = failures.map(c => c.name).join(', ');
              core.setFailed(`The following checks failed: ${names}`);
              return;
            }

            // Filter out self (this new run might show up as queued/in_progress)
            const pending = checks.check_runs.filter(c =>
                (c.status === 'in_progress' || c.status === 'queued') &&
                c.name !== 'release' && // This job name
                !c.name.includes('Auto Release') // This workflow name
            );

            if (pending.length > 0) {
               console.log("Pending checks: " + pending.map(c => c.name).join(', '));
               core.setFailed("Other workflows are still pending. Release aborted.");
            } else {
               console.log("All checks passed!");
            }

      - name: set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Debug APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-debug
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: downloaded_apk

      - name: Prepare Release Variables
        run: |
          # Calculate Version
          export BUILD_NUMBER=$(git rev-list --count HEAD)

          MAJOR=$(grep 'major=' version.properties | cut -d'=' -f2)
          MINOR=$(grep 'minor=' version.properties | cut -d'=' -f2)
          PATCH=$(grep 'patch=' version.properties | cut -d'=' -f2)
          VERSION_NAME="$MAJOR.$MINOR.$PATCH.$BUILD_NUMBER"
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

          TAG_NAME="latest-debug-v${MAJOR}.${MINOR}"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

          # Find APK
          APK_FOUND=$(find downloaded_apk -name "IDEaz-*-debug.apk" | head -n 1)
          if [ -z "$APK_FOUND" ]; then
            echo "Error: No APK file found in downloaded_apk/"
            ls -R downloaded_apk/
            exit 1
          fi

          # Enforce naming convention
          TARGET_NAME="IDEaz-${VERSION_NAME}-debug.apk"
          echo "Renaming $APK_FOUND to $TARGET_NAME"
          mv "$APK_FOUND" "$TARGET_NAME"

          echo "APK_FILE=$TARGET_NAME" >> $GITHUB_ENV



      - name: Package Local Build Tools
        run: |
          mkdir -p build_tools_package/tools
          mkdir -p build_tools_package/native

          if [ -d "app/src/main/assets/tools" ]; then
            cp -r app/src/main/assets/tools/* build_tools_package/tools/
          fi

          if [ -d "app/src/main/jniLibs/arm64-v8a" ]; then
            cp -r app/src/main/jniLibs/arm64-v8a/* build_tools_package/native/
          fi

          cd build_tools_package
          zip -r ../build-tools.zip .
          cd ..

      - name: Publish Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -fa $TAG_NAME -m "Release $TAG_NAME"
          git push origin $TAG_NAME --force

          BUILD_TOOLS_FILE="build-tools.zip"

          if gh release view $TAG_NAME > /dev/null 2>&1; then
             echo "Release $TAG_NAME already exists, editing..."
             gh release edit $TAG_NAME \
               --title "Latest Debug Build ($TAG_NAME)" \
               --notes "Debug build $TAG_NAME" \
               --target ${{ github.event.workflow_run.head_sha }} \
               --prerelease
             gh release upload $TAG_NAME "$APK_FILE" --clobber
             if [ -f "$BUILD_TOOLS_FILE" ]; then
                gh release upload $TAG_NAME "$BUILD_TOOLS_FILE" --clobber
             fi
          else
             echo "Creating new release $TAG_NAME..."
             gh release create $TAG_NAME "$APK_FILE" \
               --title "Latest Debug Build ($TAG_NAME)" \
               --notes "Debug build $TAG_NAME" \
               --target ${{ github.event.workflow_run.head_sha }} \
               --prerelease
             if [ -f "$BUILD_TOOLS_FILE" ]; then
                gh release upload $TAG_NAME "$BUILD_TOOLS_FILE" --clobber
             fi
          fi
