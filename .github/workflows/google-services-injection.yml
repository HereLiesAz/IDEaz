name: Secure Google Services JSON Injection

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  inject-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Default
      actions: write # Required to cancel other workflows

    steps:
      - name: Cancel Active Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cancelling any active or queued Auto Release runs..."
          gh run list --workflow auto-release.yml --status in_progress --json databaseId --jq '.[].databaseId' | xargs -r -I {} gh run cancel {}
          gh run list --workflow auto-release.yml --status queued --json databaseId --jq '.[].databaseId' | xargs -r -I {} gh run cancel {}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate google-services.json
        env:
          GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
        run: |
          if [ -f "app/google-services.json.template" ]; then
            echo "Template found. Injecting secrets..."
            # Convert {{VAR}} to ${VAR} and then use envsubst
            sed -e 's/{{\([^}]*\)}}/${\1}/g' app/google-services.json.template | envsubst > app/google-services.json
            echo "google-services.json created successfully."
          else
            echo "google-services.json.template not found! Skipping generation."
          fi

      - name: Verify google-services.json existence
        run: |
          if [ -f "app/google-services.json" ]; then
            echo "Verification successful: google-services.json exists."
            # Check for unreplaced placeholders
            if grep -q "{{" app/google-services.json; then
               echo "Warning: Some placeholders might not have been replaced."
            fi
          elif [ -f "app/google-services.json.template" ]; then
            echo "Verification failed: google-services.json does not exist but template does."
            exit 1
          else
            echo "Template did not exist, so file was not generated. This is expected."
          fi

      - name: Cleanup google-services.json
        if: always()
        run: |
          if [ -f "app/google-services.json" ]; then
            echo "Deleting google-services.json..."
            rm app/google-services.json
            echo "google-services.json deleted."
          else
            echo "google-services.json not found, nothing to delete."
          fi
