name: Android CI with Jules AI Debugging

on:
  workflow_dispatch:
  push:
    branches: ["**"]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write # Required to cancel other workflows

    steps:
      - name: Cancel Active Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cancelling any active or queued Auto Release runs..."
          gh run list --workflow auto-release.yml --status in_progress --json databaseId --jq '.[].databaseId' | xargs -r -I {} gh run cancel {}
          gh run list --workflow auto-release.yml --status queued --json databaseId --jq '.[].databaseId' | xargs -r -I {} gh run cancel {}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate google-services.json
        env:
          GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
        run: |
          if [ -f "app/google-services.json.template" ]; then
            echo "Template found. Injecting secrets..."
            sed -e 's/{{\([^}]*\)}}/${\1}/g' app/google-services.json.template | envsubst > app/google-services.json
            echo "google-services.json created successfully."
          else
            echo "google-services.json.template not found! Skipping generation."
          fi

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        id: gradle-build
        env:
          BUILD_NUMBER: ${{ github.run_number }}
        # capture output while still failing if build fails (but continue-on-error handles the workflow flow)
        run: |
          set +e
          export BUILD_NUMBER=$(git rev-list --count HEAD)
          ./gradlew assembleDebug --build-cache > build.log 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat build.log
          exit $EXIT_CODE
        continue-on-error: true

      - name: Upload APK
        if: steps.gradle-build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk

      # Update the release (or create it) without deleting it first to avoid downtime
      - name: Update Release
        if: steps.gradle-build.outcome == 'success' && github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAJOR=$(grep 'versionMajor' version.properties | cut -d'=' -f2)
          MINOR=$(grep 'versionMinor' version.properties | cut -d'=' -f2)
          TAG_NAME="latest-debug-v${MAJOR}.${MINOR}"
          echo "Using tag: $TAG_NAME"
          
          APK_FILE=$(ls app/build/outputs/apk/debug/*.apk | head -n 1)
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Update the tag to point to the new commit
          git tag -fa $TAG_NAME -m "Update debug release"
          git push origin $TAG_NAME --force
          
          if gh release view $TAG_NAME > /dev/null 2>&1; then
            echo "Updating existing release..."
            gh release edit $TAG_NAME \
              --prerelease \
              --title "Latest Debug Build ($TAG_NAME)" \
              --notes "Automatic build from commit $GITHUB_SHA" \
              --target $GITHUB_SHA
          
            gh release upload $TAG_NAME $APK_FILE --clobber
          else
            echo "Creating new release..."
            gh release create $TAG_NAME $APK_FILE \
              --prerelease \
              --title "Latest Debug Build ($TAG_NAME)" \
              --notes "Automatic build from commit $GITHUB_SHA" \
              --target $GITHUB_SHA
          fi
      - name: Report Failure to Jules
        if: steps.gradle-build.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let logTail = 'Log file not found.';
            try {
              const log = fs.readFileSync('build.log', 'utf8');
              logTail = log.slice(-4000); // Capture last 4000 chars
            } catch (e) {
              console.log('Error reading build.log', e);
            }
            
            const body = `@gemini-cli /jules please debug this build error\n\nBuild failed on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}.\n\n**Log Output:**\n\`\`\`\n${logTail}\n\`\`\``;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Build Failure on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}`,
              body: body,
              labels: ['jules']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: "@jules, please debug and fix this build failure. Include the suggestions from the gemini code review."
            });
      - name: Fail Job if Build Failed
        if: steps.gradle-build.outcome == 'failure'
        run: exit 1
